name: üöÄ Deploy to Contabo VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üîÅ Build & Deploy on Contabo VPS
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v3

      - name: üîê Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_DEPLOY_KEY }}

      - name: üß† Add VPS Host to Known Hosts
        run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: üöÄ Deploy & Restart on VPS
        env:
          VPS_USER: root
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
        run: |
          echo "üîç Starting deployment process..."
          echo "üìã Environment variables check:"
          echo "  - VPS_HOST: $VPS_HOST"
          echo "  - VPS_PROJECT_PATH: $VPS_PROJECT_PATH"
          echo "  - NEXT_PUBLIC_API_BASE_URL: $NEXT_PUBLIC_API_BASE_URL"
          
          # Trim whitespace and newlines from path (safety check)
          CLEAN_PATH=$(echo "$VPS_PROJECT_PATH" | tr -d '\n' | sed 's/ *$//')
          echo "  - CLEAN_PATH: $CLEAN_PATH"
          
          ssh $VPS_USER@$VPS_HOST "
            set -e
            
            echo 'üìÇ Changing to project directory: $CLEAN_PATH'
            cd '$CLEAN_PATH' || { 
              echo '‚ùå Failed to change directory to $CLEAN_PATH'
              echo 'üîç Available directories in parent:'
              ls -la \$(dirname '$CLEAN_PATH') 2>/dev/null || echo 'Cannot list parent directory'
              exit 1
            }
            echo '‚úÖ Current directory: \$(pwd)'
            
            echo 'üîç Git status before update:'
            git status --porcelain || echo 'Git status failed'
            git log --oneline -3 || echo 'Git log failed'
            
            echo 'üîÑ Fetching latest changes from GitHub...'
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            echo '‚úÖ Repository updated successfully'
            
            echo 'üîç Git status after update:'
            git log --oneline -3 || echo 'Git log failed'
            
            echo 'üîß Creating .env.local file...'
            
            # Create .env.local file with explicit echo statements to handle empty variables
            echo \"NEXT_PUBLIC_SUPABASE_URL=\${NEXT_PUBLIC_SUPABASE_URL}\" > .env.local
            echo \"NEXT_PUBLIC_SUPABASE_ANON_KEY=\${NEXT_PUBLIC_SUPABASE_ANON_KEY}\" >> .env.local
            echo \"SUPABASE_SERVICE_ROLE_KEY=\${SUPABASE_SERVICE_ROLE_KEY}\" >> .env.local
            echo \"NEXT_PUBLIC_API_BASE_URL=\${NEXT_PUBLIC_API_BASE_URL}\" >> .env.local
            echo \"NODE_ENV=production\" >> .env.local
            echo '‚úÖ Environment file created'
            echo 'üîç Environment file contents (redacted):'
            sed 's/=.*/=***REDACTED***/g' .env.local

            echo 'üì¶ Checking dependencies...'
            if [ ! -d 'node_modules' ] || git diff --name-only HEAD~1 HEAD | grep -q 'package.json\|package-lock.json'; then
              echo 'üîÑ Installing dependencies...'
              npm ci --verbose || {
                echo '‚ùå npm ci failed'
                echo 'üîç npm cache clean and retry...'
                npm cache clean --force
                npm ci --verbose || {
                  echo '‚ùå npm ci failed again - showing npm logs:'
                  cat ~/.npm/_logs/*.log 2>/dev/null | tail -50 || echo 'No npm logs found'
                  exit 1
                }
              }
            else
              echo '‚úÖ Dependencies are up to date'
            fi

            echo 'üèóÔ∏è Building the project...'
            npm run build || {
              echo '‚ùå Build failed - checking for error logs:'
              echo 'üîç Next.js build output:'
              ls -la .next/ 2>/dev/null || echo 'No .next directory found'
              echo 'üîç Package.json scripts:'
              cat package.json | grep -A 10 '\"scripts\"' || echo 'Cannot read package.json scripts'
              echo 'üîç Node and npm versions:'
              node --version
              npm --version
              exit 1
            }
            echo '‚úÖ Build completed successfully'
            
            echo 'üîç Build artifacts:'
            ls -la .next/ 2>/dev/null || echo 'No .next directory found'

            echo 'üîç Current PM2 status before restart:'
            pm2 list || echo 'PM2 not initialized yet'

            echo 'üîÅ Restarting app via PM2...'
            if pm2 describe tinchat > /dev/null 2>&1; then
              echo 'üîÑ Restarting existing PM2 process...'
              pm2 restart tinchat
            else
              echo 'üÜï Starting new PM2 process...'
              pm2 start npm --name 'tinchat' -- start
            fi
            
            echo 'üíæ Saving PM2 configuration...'
            pm2 save

            echo 'üîç Final PM2 status:'
            pm2 list
            
            echo 'üîç PM2 process details:'
            pm2 describe tinchat || echo 'Cannot describe tinchat process'
            
            echo 'üîç Recent PM2 logs (last 15 lines):'
            pm2 logs tinchat --lines 15 --nostream || echo 'No logs available yet'
            
            echo 'üîç Testing application response...'
            sleep 5  # Give the app time to start
            
            # Test multiple ports
            for port in 3000 8080 8000 5000; do
              if curl -f -s http://localhost:\$port > /dev/null; then
                echo '‚úÖ Application is responding on port '\$port
                break
              else
                echo '‚ö†Ô∏è No response on port '\$port
              fi
            done
            
            echo 'üîç Network status:'
            netstat -tlnp | grep -E ':(3000|8080|8000|5000)' || echo 'No services found on common ports'
            
            echo 'üîç PM2 process memory/CPU usage:'
            pm2 monit --no-interaction || echo 'Cannot show PM2 monitoring'

            echo '‚úÖ Deployment completed successfully!'
          "