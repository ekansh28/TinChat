name: ğŸš€ Deploy Server to VPS

on:
  push:
    branches:
      - main
    paths:
      - 'server/**'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    name: ğŸ” Deploy Server on VPS
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v3

      - name: ğŸ” Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_DEPLOY_KEY }}

      - name: ğŸ§  Add VPS Host to Known Hosts
        run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ” Verify Environment Variables
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
        run: |
          echo "ğŸ” Checking environment variables for server deployment:"
          echo "  - VPS_HOST length: ${#VPS_HOST}"
          echo "  - VPS_PROJECT_PATH length: ${#VPS_PROJECT_PATH}"
          
          if [[ -z "$VPS_HOST" ]]; then
            echo "âŒ VPS_HOST is empty!"
            exit 1
          fi
          
          if [[ -z "$VPS_PROJECT_PATH" ]]; then
            echo "âŒ VPS_PROJECT_PATH is empty!"
            exit 1
          fi
          
          echo "âœ… Required environment variables are present"

      - name: ğŸš€ Deploy Server on VPS
        env:
          VPS_USER: root
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
        run: |
          echo "ğŸ” Starting server deployment process..."
          echo "ğŸ“‹ Environment variables check:"
          echo "  - VPS_HOST: $VPS_HOST"
          echo "  - VPS_PROJECT_PATH: $VPS_PROJECT_PATH"
          
          # Trim whitespace and newlines from path (safety check)
          CLEAN_PATH=$(echo "$VPS_PROJECT_PATH" | tr -d '\n' | sed 's/ *$//')
          echo "  - CLEAN_PATH: $CLEAN_PATH"
          
          # First-time setup check
          echo "ğŸ› ï¸ Checking if project directory exists..."
          ssh $VPS_USER@$VPS_HOST "
            if [ ! -d '$CLEAN_PATH' ]; then
              echo 'ğŸ› ï¸ First-time setup: Creating project directory...'
              mkdir -p '$CLEAN_PATH'
              echo 'ğŸ“¥ Cloning repository...'
              git clone https://github.com/ekansh28/TinChat.git '$CLEAN_PATH'
              echo 'âœ… Repository cloned successfully'
            else
              echo 'âœ… Project directory already exists'
            fi
          "
          
          # Main server deployment
          echo "ğŸš€ Starting main server deployment process..."
          ssh $VPS_USER@$VPS_HOST "
            set -e
            
            echo 'ğŸ“‚ Changing to project directory...'
            cd '$CLEAN_PATH' || { echo 'âŒ Directory missing'; exit 1; }
            echo 'âœ… Current directory: \$(pwd)'
            
            echo 'ğŸ”„ Force updating repository...'
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            echo 'âœ… Repository updated successfully'
            
            echo 'ğŸ” Checking server directory...'
            if [ -d \"server\" ]; then
              echo 'âœ… Server directory found'
              ls -la server/
            else
              echo 'âŒ Server directory not found!'
              echo 'ğŸ” Available directories:'
              ls -la
              exit 1
            fi
            
            echo 'ğŸ“¦ Installing server dependencies...'
            
            # Check if server has its own package.json
            if [ -f \"server/package.json\" ]; then
              echo 'ğŸ“¦ Installing server-specific dependencies...'
              cd server
              
              # Clean install for server
              rm -rf node_modules package-lock.json
              npm cache clean --force 2>/dev/null || true
              
              npm install --no-audit --no-fund || {
                echo 'âŒ Server npm install failed, trying alternatives...'
                npm install --legacy-peer-deps --no-audit --no-fund || {
                  echo 'âŒ Server dependency installation failed'
                  echo 'ğŸ” Node and npm versions:'
                  node --version
                  npm --version
                  echo 'ğŸ” Server package.json:'
                  cat package.json | head -20
                  exit 1
                }
              }
              
              echo 'âœ… Server dependencies installed'
              cd ..
            else
              echo 'ğŸ“¦ Installing root project dependencies for server...'
              
              # Clean install for root project
              rm -rf node_modules package-lock.json
              npm cache clean --force 2>/dev/null || true
              
              npm install --no-audit --no-fund || {
                echo 'âŒ Root npm install failed, trying alternatives...'
                npm install --legacy-peer-deps --no-audit --no-fund || {
                  echo 'âŒ Root dependency installation failed'
                  exit 1
                }
              }
              
              echo 'âœ… Root dependencies installed'
            fi
            
            echo 'ğŸ” Checking for TypeScript compilation...'
            if [ -f \"server/tsconfig.json\" ] || grep -q '\"tsx\"' package.json 2>/dev/null; then
              echo 'ğŸ”§ TypeScript detected, checking if compilation is needed...'
              if [ -f \"server/dist\" ] || npm run --silent server:build >/dev/null 2>&1; then
                echo 'âœ… TypeScript compilation successful or not needed'
              else
                echo 'âš ï¸ TypeScript compilation skipped or failed, continuing...'
              fi
            else
              echo 'âœ… No TypeScript compilation needed'
            fi
            
            echo 'ğŸ” Checking current PM2 status...'
            pm2 list || echo 'PM2 not initialized yet'
            
            echo 'ğŸš€ Managing server PM2 process...'
            
            # Check if there's a specific server start script
            if grep -q '\"server:' package.json 2>/dev/null; then
              echo 'ğŸ” Found server scripts in package.json'
              
              # Kill existing server process if running
              if pm2 describe tinchat-server > /dev/null 2>&1; then
                echo 'ğŸ”„ Stopping existing server process...'
                pm2 delete tinchat-server || echo 'Failed to delete existing process'
              fi
              
              # Start new server process
              echo 'ğŸ†• Starting new server process...'
              if npm run server:dev >/dev/null 2>&1 &
              then
                echo 'âœ… Server started with npm run server:dev'
                
                # Try to register with PM2 for monitoring
                pm2 start \"npm run server:dev\" --name \"tinchat-server\" || {
                  echo 'âš ï¸ PM2 registration failed, but server might be running'
                }
              else
                echo 'âŒ Failed to start server'
                exit 1
              fi
              
            elif [ -f \"server/index.js\" ] || [ -f \"server/index.ts\" ]; then
              echo 'ğŸ” Found server entry point'
              
              if pm2 describe tinchat-server > /dev/null 2>&1; then
                echo 'ğŸ”„ Restarting existing PM2 server process...'
                pm2 restart tinchat-server
              else
                echo 'ğŸ†• Starting new PM2 server process...'
                if [ -f \"server/index.ts\" ]; then
                  pm2 start server/index.ts --name 'tinchat-server' --interpreter tsx
                else
                  pm2 start server/index.js --name 'tinchat-server'
                fi
              fi
            else
              echo 'âŒ No server entry point found!'
              echo 'ğŸ” Server directory contents:'
              ls -la server/
              exit 1
            fi
            
            echo 'ğŸ’¾ Saving PM2 configuration...'
            pm2 save
            
            echo 'ğŸ” Final PM2 status:'
            pm2 list
            
            echo 'ğŸ” Checking PM2 server logs (last 10 lines):'
            pm2 logs tinchat-server --lines 10 --nostream || echo 'No server logs available yet'
            
            echo 'ğŸ” Testing server response...'
            sleep 5  # Give the server time to start
            
            # Test common server ports
            for port in 3001 8080 8000 5000 4000; do
              if curl -f -s http://localhost:\$port > /dev/null; then
                echo 'âœ… Server is responding on port '\$port
                break
              else
                echo 'âš ï¸ No response on port '\$port
              fi
            done
            
            echo 'ğŸ” Network status (server ports):'
            netstat -tlnp | grep -E ':(3001|8080|8000|5000|4000)' || echo 'No server services found on common ports'
            
            echo 'ğŸ” PM2 server process memory/CPU usage:'
            pm2 show tinchat-server || echo 'Cannot show server PM2 details'
            
            echo 'âœ… Server deployment completed successfully!'
          "