- name: ðŸš€ Deploy & Restart on VPS
  env:
    VPS_USER: root
    VPS_HOST: ${{ secrets.VPS_HOST }}
    VPS_PROJECT_PATH: ${{ secrets.VPS_PROJECT_PATH }}
    NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
    NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
    SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
    NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
  run: |
    # First-time setup check
    ssh root@$VPS_HOST "
      if [ ! -d '$VPS_PROJECT_PATH' ]; then
        echo 'ðŸ› ï¸ First-time setup: Creating project directory...'
        mkdir -p '$VPS_PROJECT_PATH'
        git clone https://github.com/ekansh28/TinChat.git '$VPS_PROJECT_PATH'
      fi
    "
    
    # Main deployment
    ssh root@$VPS_HOST "
      set -e
      cd '$VPS_PROJECT_PATH' || { echo 'âŒ Directory missing'; exit 1; }
      
      echo 'ðŸ”„ Force updating repository...'
      git fetch --all
      git reset --hard origin/main
      git clean -fd
      
      echo 'ðŸ”§ Creating .env file...'
      cat > .env <<'ENV_EOF'
      NEXT_PUBLIC_SUPABASE_URL=$NEXT_PUBLIC_SUPABASE_URL
      NEXT_PUBLIC_SUPABASE_ANON_KEY=$NEXT_PUBLIC_SUPABASE_ANON_KEY
      SUPABASE_SERVICE_ROLE_KEY=$SUPABASE_SERVICE_ROLE_KEY
      NEXT_PUBLIC_API_BASE_URL=$NEXT_PUBLIC_API_BASE_URL
      NODE_ENV=production
      ENV_EOF
      
      echo 'ðŸ“¦ Installing dependencies...'
      npm ci
      
      echo 'ðŸ—ï¸ Building project...'
      npm run build
      
      echo 'ðŸš€ Starting PM2 process...'
      pm2 delete tinchat || true
      pm2 start npm --name 'tinchat' -- start
      pm2 save
      pm2 startup
    "